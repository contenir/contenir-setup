<?php
// Default values for database configuration
$cmsDbPath = $formData['cms_database'] ?? getcwd() . '/data/cms/cms.db';
$siteHostname = $formData['site_hostname'] ?? 'localhost';
$sitePort = $formData['site_port'] ?? '3306';
$siteDatabase = $formData['site_database'] ?? '';
$siteUsername = $formData['site_username'] ?? '';
?>
<div style="max-width: 800px; margin: 50px auto; padding: 30px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h1 style="margin-top: 0; text-align: center;">Contenir CMS Setup</h1>

    <?php if ($error): ?>
        <div style="padding: 15px; background: #ffebee; border: 1px solid #c62828; border-radius: 4px; margin-bottom: 20px; color: #c62828;">
            <?= $this->escapeHtml($error) ?>
        </div>
    <?php endif; ?>

    <?php if ($success): ?>
        <div style="padding: 15px; background: #e8f5e9; border: 1px solid #2e7d32; border-radius: 4px; margin-bottom: 20px; color: #2e7d32;">
            <?= $this->escapeHtml($success) ?>
        </div>
    <?php endif; ?>

    <?php if ($step === 'installed'): ?>
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 48px; margin-bottom: 20px; color: #4caf50;">✓</div>
            <h2>System Already Installed</h2>
            <p style="font-size: 16px; color: #666; margin: 20px 0;">
                Contenir CMS is already installed and configured.
            </p>
        </div>

        <div style="border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 4px; background: #f9f9f9;">
            <h3 style="margin-top: 0;">Installation Status</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="padding: 10px 0; border-bottom: 1px solid #ddd;">
                    <strong>Database:</strong>
                    <?php if ($dbExists): ?>
                        <span style="color: #4caf50;">✓ Found</span>
                    <?php else: ?>
                        <span style="color: #f44336;">✗ Not Found</span>
                    <?php endif; ?>
                </li>
                <li style="padding: 10px 0; border-bottom: 1px solid #ddd;">
                    <strong>Migrations:</strong>
                    <?php if ($isInstalled): ?>
                        <span style="color: #4caf50;">✓ Up to date</span>
                    <?php else: ?>
                        <span style="color: #f44336;">✗ Pending</span>
                    <?php endif; ?>
                </li>
                <li style="padding: 10px 0;">
                    <strong>Status:</strong>
                    <span style="color: #4caf50;">Ready</span>
                </li>
            </ul>
        </div>

        <div style="margin: 30px 0;">
            <h3>Setup Options</h3>
            <p style="color: #666; margin-bottom: 20px;">
                If you're experiencing issues, you can run diagnostics or check your configuration:
            </p>

            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <form method="POST" style="display: inline-block;">
                    <input type="hidden" name="action" value="diagnostics" />
                    <button
                        type="submit"
                        style="padding: 12px 30px; background: #2196f3; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;"
                    >
                        Run Diagnostics
                    </button>
                </form>

                <a
                    href="/setup?force=1"
                    style="display: inline-block; padding: 12px 30px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 16px; text-decoration: none;"
                >
                    Reconfigure Database
                </a>

                <a
                    href="/admin"
                    style="display: inline-block; padding: 12px 30px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 16px; text-decoration: none;"
                >
                    Go to Admin
                </a>
            </div>
        </div>

        <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
            <p style="margin: 0; color: #856404;">
                <strong>Note:</strong> To force a fresh installation workflow, click "Reconfigure Database" above.
                This allows you to update your database credentials or create a new admin user without deleting existing data.
            </p>
        </div>
    <?php endif; ?>

    <?php if ($step === 'welcome'): ?>
        <div style="text-align: center; margin-bottom: 30px;">
            <h2>Welcome to Contenir CMS</h2>
            <p style="font-size: 16px; color: #666; margin: 20px 0;">
                This wizard will guide you through the installation process.
            </p>
            <p style="font-size: 14px; color: #666;">
                The installer will:
            </p>
            <ul style="text-align: left; display: inline-block; margin: 20px auto;">
                <li>Check system requirements</li>
                <li>Verify file permissions</li>
                <li>Configure database connections</li>
                <li>Create the CMS database</li>
                <li>Set up default user roles and permissions</li>
                <li>Create initial administrator account</li>
            </ul>
        </div>

        <form method="POST" style="text-align: center;">
            <input type="hidden" name="action" value="diagnostics" />
            <button
                type="submit"
                style="padding: 15px 40px; background: #2c3e50; color: white; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer;"
            >
                Begin Installation
            </button>
        </form>
    <?php endif; ?>

    <?php if ($step === 'diagnostics' && $diagnostics): ?>
        <h2>System Diagnostics</h2>

        <div style="margin: 20px 0;">
            <?php foreach ($diagnostics['results'] as $key => $result): ?>
                <div style="padding: 10px; margin-bottom: 10px; border: 1px solid <?= $result['success'] ? '#4caf50' : '#f44336' ?>; border-radius: 4px; background: <?= $result['success'] ? '#e8f5e9' : '#ffebee' ?>;">
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 20px; margin-right: 10px;">
                            <?= $result['success'] ? '✓' : '✗' ?>
                        </span>
                        <span style="flex: 1; color: <?= $result['success'] ? '#2e7d32' : '#c62828' ?>;">
                            <?= $this->escapeHtml($result['message']) ?>
                        </span>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>

        <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <?php if ($diagnostics['success']): ?>
                <form method="POST" style="display: inline-block;">
                    <input type="hidden" name="action" value="database-config" />
                    <input type="hidden" name="proceed" value="1" />
                    <button
                        type="submit"
                        style="padding: 15px 40px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer;"
                    >
                        Configure Database
                    </button>
                </form>
                <a
                    href="/setup"
                    style="display: inline-block; padding: 15px 40px; background: #666; color: white; border: none; border-radius: 4px; font-size: 18px; text-decoration: none;"
                >
                    Back to Status
                </a>
            <?php else: ?>
                <form method="POST" style="display: inline-block;">
                    <input type="hidden" name="action" value="diagnostics" />
                    <button
                        type="submit"
                        style="padding: 12px 30px; background: #2c3e50; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;"
                    >
                        Retry Diagnostics
                    </button>
                </form>

                <form method="POST" style="display: inline-block;">
                    <input type="hidden" name="action" value="database-config" />
                    <input type="hidden" name="proceed" value="1" />
                    <button
                        type="submit"
                        style="padding: 12px 30px; background: #ff9800; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;"
                        title="Proceed to database configuration despite warnings"
                    >
                        Continue Anyway
                    </button>
                </form>

                <a
                    href="/setup"
                    style="display: inline-block; padding: 12px 30px; background: #666; color: white; border: none; border-radius: 4px; font-size: 16px; text-decoration: none;"
                >
                    Back to Status
                </a>
            <?php endif; ?>
        </div>

        <?php if (! $diagnostics['success']): ?>
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                <p style="margin: 0; color: #856404;">
                    <strong>Warning:</strong> Some diagnostics failed, but you can continue anyway if you want to proceed with setup.
                    The issues above may cause problems during installation.
                </p>
            </div>
        <?php endif; ?>
    <?php endif; ?>

    <?php if ($step === 'database-config'): ?>
        <h2>Database Configuration</h2>
        <p style="color: #666; margin-bottom: 20px;">Configure your database connections below:</p>

        <form method="POST">
            <input type="hidden" name="action" value="database-config" />

            <fieldset style="border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 4px;">
                <legend style="font-weight: bold; padding: 0 10px;">CMS Database (SQLite)</legend>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Database Path:</label>
                    <input
                        type="text"
                        name="cms_database"
                        value="<?= $this->escapeHtmlAttr($cmsDbPath) ?>"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                        required
                    />
                    <small style="color: #666;">Path to SQLite database file (will be created if it doesn't exist)</small>
                </div>
            </fieldset>

            <fieldset style="border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 4px;">
                <legend style="font-weight: bold; padding: 0 10px;">Site Database (MySQL)</legend>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Hostname:</label>
                    <input
                        type="text"
                        name="site_hostname"
                        value="<?= $this->escapeHtmlAttr($siteHostname) ?>"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                    />
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Port:</label>
                    <input
                        type="number"
                        name="site_port"
                        value="<?= $this->escapeHtmlAttr($sitePort) ?>"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                    />
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Database Name:</label>
                    <input
                        type="text"
                        name="site_database"
                        value="<?= $this->escapeHtmlAttr($siteDatabase) ?>"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                        required
                    />
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
                    <input
                        type="text"
                        name="site_username"
                        value="<?= $this->escapeHtmlAttr($siteUsername) ?>"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                        required
                    />
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                    <input
                        type="password"
                        name="site_password"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                    />
                </div>
            </fieldset>

            <div style="text-align: center;">
                <button
                    type="submit"
                    style="padding: 15px 40px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer;"
                >
                    Save & Test Connection
                </button>
            </div>
        </form>
    <?php endif; ?>

    <?php if ($step === 'test-connection'): ?>
        <h2>Test Database Connection</h2>
        <p style="color: #666; margin-bottom: 20px;">Database configuration has been saved. Test the connection to proceed.</p>

        <form method="POST" style="text-align: center; margin-top: 30px;">
            <input type="hidden" name="action" value="test-connection" />
            <button
                type="submit"
                style="padding: 15px 40px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer;"
            >
                Test Connection
            </button>
        </form>
    <?php endif; ?>

    <?php if ($step === 'admin-user'): ?>
        <h2>Create Administrator Account</h2>
        <p style="color: #666; margin-bottom: 20px;">Create your initial administrator account:</p>

        <form method="POST">
            <input type="hidden" name="action" value="install" />

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
                <input
                    type="text"
                    name="admin_username"
                    value="admin"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                    required
                />
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                <input
                    type="email"
                    name="admin_email"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                    required
                />
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                <input
                    type="password"
                    name="admin_password"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                    required
                    minlength="8"
                />
                <small style="color: #666;">Minimum 8 characters</small>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button
                    type="submit"
                    style="padding: 15px 40px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 18px; font-weight: bold; cursor: pointer;"
                >
                    Complete Installation
                </button>
            </div>
        </form>
    <?php endif; ?>

    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
        <p style="color: #666; font-size: 13px;">
            Contenir CMS &copy; <?= date('Y') ?>
        </p>
    </div>
</div>